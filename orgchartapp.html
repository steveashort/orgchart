<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Org Viewer Pro</title>
    <style>
        /* ==========================================================
           1) THEME VARIABLES
           ========================================================== */
        :root {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --card-border: #333;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #3498db;
            --hover-bg: #252525;
            --input-bg: #2d2d2d;
            --input-border: #444;
            --line-color: #444;
            --h-0: #3498db; --h-1: #9b59b6; --h-2: #e67e22; 
            --h-3: #2ecc71; --h-4: #e74c3c; --h-5: #f1c40f;
        }

        body.light-theme {
            --bg-color: #f4f4f4;
            --sidebar-bg: #e0e0e0;
            --card-bg: #ffffff;
            --card-border: #d0d0d0;
            --text-main: #333333;
            --text-muted: #666666;
            --accent: #2980b9;
            --hover-bg: #f9f9f9;
            --input-bg: #ffffff;
            --input-border: #bdc3c7;
            --line-color: #cccccc;
        }

        /* ==========================================================
           2) PAGE LAYOUT
           ========================================================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--card-border);
            padding: 30px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar-logo {
            width: 100%;
            max-height: 100px;
            object-fit: contain;
            margin-bottom: 30px;
            display: none;
        }

        .main-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .main-header {
            height: 70px;
            background: var(--bg-color);
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            flex-shrink: 0;
        }

        #headerOrgName {
            font-size: 26px;
            font-weight: bold;
            color: var(--text-main);
        }

        .edit-mode-pill {
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .main-content { 
            flex: 1; 
            padding: 40px; 
            overflow: auto; 
            position: relative;
        }

        /* Scrollbars */
        .main-content::-webkit-scrollbar { width: 14px; height: 14px; }
        .main-content::-webkit-scrollbar-track { background: var(--bg-color); }
        .main-content::-webkit-scrollbar-thumb { 
            background-color: var(--accent); 
            border-radius: 10px; 
            border: 3px solid var(--bg-color); 
        }

        .control-group { margin-bottom: 25px; }
        .sidebar .control-group label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        
        select, input[type="text"], textarea, input[type="file"] {
            width: 100%; padding: 14px; background: var(--input-bg); color: var(--text-main);
            border: 1px solid var(--input-border); border-radius: 6px; outline: none; box-sizing: border-box;
            font-size: 14px;
        }

        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        button { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: opacity 0.2s; }
        .btn-success { background-color: #27ae60; color: white; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-secondary { background-color: #555; color: white; }
        .btn-publish { background-color: #8e44ad; color: white; }

        .floating-toolbar { position: fixed; top: 90px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 500; }
        .icon-btn { width: 46px; height: 46px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--card-border); color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }

        /* ==========================================================
           3) TREE & NODES
           ========================================================== */
        .main-tree {
            display: inline-block;
            min-width: max-content; 
            padding-right: 250px; 
            padding-bottom: 250px; 
        }
        ul { list-style: none; padding-left: 20px; margin: 0; position: relative; }
        ul.children-list { border-left: 2px solid var(--line-color); margin-left: 15px; padding-left: 30px; }
        ul.hidden { display: none !important; }
        li { margin: 25px 0; position: relative; }
        li::before { content: ''; position: absolute; top: 32px; left: -32px; width: 30px; height: 2px; background-color: var(--line-color); }

        .node-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 20px;
            border-radius: 8px;
            width: fit-content; min-width: 320px;
            cursor: pointer;
            position: relative;
            border-left: 6px solid var(--accent);
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
            white-space: normal;
        }
        
        .node-actions { position: absolute; top: -14px; right: 10px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .node-card:hover .node-actions { opacity: 1; }
        .node-action-btn { width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        .btn-add-child { background: #27ae60; }
        .btn-del-node { background: #c0392b; }

        .info { display: flex; flex-direction: column; pointer-events: none; }
        .name { font-weight: 700; font-size: 18px; color: var(--text-main); }
        .role { font-size: 13px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }
        .contact-info { font-size: 12px; color: var(--text-muted); margin-top: 8px; }
        
        .pills-row { display: flex; gap: 8px; margin-top: 10px; }
        .engagement-pill { font-size: 10px; color: var(--accent); border: 1px solid var(--accent); padding: 2px 8px; border-radius: 12px; font-weight: 700; text-transform: uppercase; }
        .location-pill { font-size: 10px; color: #2ecc71; border: 1px solid #2ecc71; padding: 2px 8px; border-radius: 12px; font-weight: 700; text-transform: uppercase; }
        
        .tags-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .hide-tags .tags-row { display: none !important; }
        
        .pill { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 800; color: white; text-transform: uppercase; }
        .bw-tags .pill { background: #444 !important; border: 1px solid #666; color: #eee !important; }

        .toggle-btn { 
            position: absolute; left: -14px; top: 20px; width: 26px; height: 26px; 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid var(--input-border); border-radius: 4px; 
            background: var(--input-bg); cursor: pointer; font-weight: bold; z-index: 15;
            color: var(--text-muted);
        }

        .matched { border: 2px solid #27ae60 !important; box-shadow: 0 0 15px rgba(39, 174, 96, 0.4) !important; }

        /* READONLY MODE HIDING */
        .readonly-mode .node-actions,
        .readonly-mode .icon-btn[title="Settings"],
        .readonly-mode #toolsSection,
        .readonly-mode .edit-mode-pill {
            display: none !important;
        }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--sidebar-bg); padding: 45px; border-radius: 12px; width: 700px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--card-border); }
        .form-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .form-row > div { flex: 1; }
        .form-group { margin-bottom: 30px; }
        .modal label { display: block; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; font-size: 12px; color: var(--text-muted); }

        .guide-text { line-height: 1.6; }
        .guide-text ul { padding-left: 20px; list-style-type: disc; }
        .guide-text li { margin-bottom: 10px; margin-top: 0; white-space: normal; position: static; }
        .guide-text li::before { display: none; }

        .toast-container { position: fixed; bottom: 25px; right: 25px; z-index: 3000; }
        .toast { background: #333; color: white; padding: 14px 24px; border-radius: 4px; border-left: 4px solid var(--accent); margin-top: 12px; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <img id="sidebarLogo" src="" alt="Logo" class="sidebar-logo">
        
        <div class="control-group">
            <label>Search Hierarchy</label>
            <input type="text" id="searchInput" placeholder="Search any field..." oninput="applyFilter()">
        </div>

        <div class="control-group"><label>Filter by Role</label><select id="roleFilter" onchange="applyFilter()"><option value="ALL">Show All</option></select></div>
        <div class="control-group"><label>Filter by Location</label><select id="locFilter" onchange="applyFilter()"><option value="ALL">Show All</option></select></div>
        <div class="control-group"><label>Filter by Tag</label><select id="tagFilter" multiple size="8" onchange="handleTagSelection(this)"></select></div>

        <div id="toolsSection" class="control-group" style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--card-border);">
            <label>Hierarchy Tools</label>
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="importJson(this)">
            <div class="btn-group">
                <button class="btn-success" onclick="triggerUpload()">Load Hierarchy</button>
                <button class="btn-primary" onclick="saveJson()">Save Hierarchy</button>
                <button class="btn-publish" onclick="publishHierarchy()">Publish to Read-Only</button>
            </div>
        </div>
    </aside>

    <div class="main-window">
        <header class="main-header">
            <div id="headerOrgName">Org Viewer Pro</div>
            <div id="editModePill" class="edit-mode-pill">Edit Mode</div>
        </header>
        <main class="main-content" id="mainDisplay">
            <div id="tree-container" class="main-tree"></div>
        </main>
    </div>
</div>

<div class="floating-toolbar">
    <button class="icon-btn" onclick="openSettingsModal()" title="Settings">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </button>
    <button class="icon-btn" onclick="expandAll()" title="Expand All"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
    <button class="icon-btn" onclick="collapseAll()" title="Collapse All"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
    <button class="icon-btn" onclick="toggleTheme()" title="Toggle Day/Night Mode">
        <svg id="sunIcon" style="width:22px; height:22px; display:none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg id="moonIcon" style="width:22px; height:22px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
    </button>
    <button class="icon-btn" onclick="openGuideModal()" title="User Guide" style="margin-top: 10px; background: var(--accent); color: white;">
        <span style="font-weight: bold; font-size: 20px;">?</span>
    </button>
</div>

<div class="modal-overlay" id="guideModal">
    <div class="modal">
        <h2 id="guideTitle">User Guide</h2>
        <div class="guide-text" id="guideBody">
            </div>
        <div style="display:flex; justify-content:flex-end; margin-top: 25px;">
            <button class="btn-primary" onclick="closeGuideModal()">Got it!</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal">
        <h2>Edit Individual</h2>
        <input type="hidden" id="editNodeId">
        <div class="form-row">
            <div><label>Name</label><input type="text" id="editName"></div>
            <div><label>Role</label><select id="editRole"></select></div>
        </div>
        <div class="form-row">
            <div><label>Email</label><input type="text" id="editEmail"></div>
            <div><label>Phone</label><input type="text" id="editPhone"></div>
        </div>
        <div class="form-row">
            <div><label>Location</label><select id="editLocation"></select></div>
            <div><label>Engagement</label><select id="editEngagement"></select></div>
        </div>
        <div class="form-group"><label>Tags (Select Multiple)</label><select id="editTagsMulti" multiple size="6"></select></div>
        <div style="display:flex; justify-content:flex-end; gap:15px; margin-top: 35px;">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" onclick="saveNodeChanges()">Update Record</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <h2>Configuration</h2>
        <div class="form-group"><label>Organization Name</label><input type="text" id="setOrgName"></div>
        
        <div class="form-group" style="padding: 20px; border: 2px dashed var(--card-border); border-radius: 8px; text-align: center;">
            <label style="margin-bottom: 15px;">Embed Company Logo for Publishing</label>
            <input type="file" id="setLogoFile" accept="image/*" onchange="handleLogoUpload(this)" style="max-width: 300px; margin: 0 auto;">
        </div>

        <div class="form-row">
            <div>
                <label>View Options</label>
                <div style="display:flex; flex-direction:column; gap:12px; padding: 10px 0;">
                    <label style="text-transform:none; font-size:14px; font-weight:normal; display:flex; align-items:center; gap:10px;"><input type="checkbox" id="setShowTags" style="width:auto; margin:0;"> Show Tags Row</label>
                    <label style="text-transform:none; font-size:14px; font-weight:normal; display:flex; align-items:center; gap:10px;"><input type="checkbox" id="setBWTags" style="width:auto; margin:0;"> Monochrome Mode</label>
                </div>
            </div>
        </div>
        <div class="form-group"><label>Roles (CSV)</label><textarea id="setRoles" rows="3"></textarea></div>
        <div class="form-group"><label>Locations (CSV)</label><textarea id="setLocs" rows="3"></textarea></div>
        <div class="form-group"><label>Tags (CSV)</label><textarea id="setTags" rows="3"></textarea></div>
        <div class="form-group"><label>Engagement (CSV)</label><textarea id="setEng" rows="3"></textarea></div>
        <div style="display:flex; justify-content:flex-end; gap:15px; margin-top: 35px;">
            <button class="btn-secondary" onclick="closeSettingsModal()">Discard</button>
            <button class="btn-primary" onclick="saveSettings()">Save & Refresh</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script id="appStateScript">
    // START_DATA_ANCHOR
    let appData = {
        isReadOnly: false,
        title: "Org Viewer Pro",
        logoData: "", 
        settings: {
            theme: "dark", 
            showTags: true, 
            bwTags: false,
            roles: ["CTO", "Manager", "Developer"],
            locations: ["New York", "Paris", "London"],
            tags: ["Owner", "Cloud", "Unix", "Linux", "Java"],
            engagements: ["Internal", "Contract", "Consultant"]
        },
        tree: {
            id: "root-1", 
            name: "John Smith", 
            role: "CTO", 
            location: "New York", 
            engagement: "Internal", 
            phone: "555-0100", 
            email: "john.smith@org.com", 
            tags: ["Owner"],
            children: []
        }
    };
    // END_DATA_ANCHOR

    // --- LOGIC UTILS ---
    function findNodeAndParent(id, currentNode, parent = null) {
        if (currentNode.id === id) return { node: currentNode, parent: parent };
        if (currentNode.children) {
            for (let child of currentNode.children) {
                const res = findNodeAndParent(id, child, currentNode);
                if (res) return res;
            }
        }
        return null;
    }

    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        return `hsl(${Math.abs(hash) % 360}, 65%, 40%)`;
    }

    function showToast(m) {
        const t = document.createElement('div'); t.className='toast'; t.textContent=m;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(()=>t.remove(), 3000);
    }

    // --- LOGO ---
    function handleLogoUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            appData.logoData = e.target.result;
            updateLogoDisplay();
            showToast("Logo embedded.");
        };
        reader.readAsDataURL(file);
    }

    function updateLogoDisplay() {
        const logo = document.getElementById('sidebarLogo');
        if (appData.logoData) { logo.src = appData.logoData; logo.style.display = 'block'; }
        else { logo.style.display = 'none'; }
    }

    // --- RENDERING ---
    function renderTree() {
        if (appData.isReadOnly) document.body.classList.add('readonly-mode');
        else document.body.classList.remove('readonly-mode');

        document.getElementById('headerOrgName').textContent = appData.title;
        updateLogoDisplay();

        const main = document.getElementById('mainDisplay');
        appData.settings.showTags ? main.classList.remove('hide-tags') : main.classList.add('hide-tags');
        appData.settings.bwTags ? main.classList.add('bw-tags') : main.classList.remove('bw-tags');
        
        const container = document.getElementById('tree-container');
        container.innerHTML = '';
        const rootUl = document.createElement('ul');
        container.appendChild(rootUl);
        buildNode(appData.tree, rootUl, 0);
        populateSidebarFilters();
        applyFilter();
    }

    function buildNode(data, parentElement, depth) {
        const li = document.createElement('li');
        li.className = "tree-item"; li.dataset.id = data.id;

        const tags = data.tags || [];
        li.dataset.tags = tags.join(',').toUpperCase();
        li.dataset.location = (data.location || "").toUpperCase();
        li.dataset.role = (data.role || "").toUpperCase();
        li.dataset.searchText = `${data.name} ${data.role} ${data.location} ${data.engagement} ${data.email} ${data.phone} ${tags.join(' ')}`.toUpperCase();

        const card = document.createElement('div');
        card.className = 'node-card'; card.dataset.nodeId = data.id;
        card.style.borderLeftColor = `var(--h-${depth % 6})`;

        if (data.children && data.children.length > 0) {
            const toggle = document.createElement('div');
            toggle.className = 'toggle-btn'; toggle.textContent = '−';
            toggle.onclick = (e) => {
                e.stopPropagation();
                const childUl = li.querySelector('ul.children-list');
                const isHidden = childUl.classList.toggle('hidden');
                toggle.textContent = isHidden ? '+' : '−';
            };
            card.appendChild(toggle);
        }

        const cardContent = `
            <div class="node-actions">
                <button class="node-action-btn btn-add-child" onclick="addChild('${data.id}', event)"><svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
                <button class="node-action-btn btn-del-node" onclick="deleteNode('${data.id}', event)"><svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
            </div>
            <div class="info">
                <div class="top-row">
                    <span class="name">${data.name}</span>
                    ${data.engagement ? `<span class="engagement-pill">${data.engagement}</span>`:''}
                    ${data.location ? `<span class="location-pill">${data.location}</span>`:''}
                </div>
                <span class="role">${data.role || ''}</span>
                <div class="contact-info">${data.email || ''} ${data.phone ? ' • ' + data.phone : ''}</div>
                <div class="tags-row">${tags.map(t => `<span class="pill" style="background:${stringToColor(t)}">${t}</span>`).join('')}</div>
            </div>
        `;
        card.insertAdjacentHTML('beforeend', cardContent);
        
        if (!appData.isReadOnly) {
            card.onclick = () => openEditModal(data.id);
            card.draggable = true;
            card.addEventListener('dragstart', (e) => e.dataTransfer.setData("text", data.id));
            card.addEventListener('dragover', (e) => e.preventDefault());
            card.addEventListener('drop', (e) => {
                e.preventDefault();
                const sourceId = e.dataTransfer.getData("text");
                if (sourceId === data.id) return;
                const source = findNodeAndParent(sourceId, appData.tree);
                if (source.parent) source.parent.children = source.parent.children.filter(c => c.id !== sourceId);
                if(!data.children) data.children = [];
                data.children.push(source.node);
                renderTree();
            });
        }

        li.appendChild(card);
        if (data.children && data.children.length > 0) {
            const cul = document.createElement('ul'); cul.className = 'children-list';
            data.children.forEach(c => buildNode(c, cul, depth + 1));
            li.appendChild(cul);
        }
        parentElement.appendChild(li);
    }

    // --- PUBLISH ---
    function publishHierarchy() {
        let publishedData = JSON.parse(JSON.stringify(appData));
        publishedData.isReadOnly = true;
        const fullSource = document.documentElement.outerHTML;
        const scriptStart = "// START_DATA_ANCHOR";
        const scriptEnd = "// END_DATA_ANCHOR";
        const startIndex = fullSource.indexOf(scriptStart);
        const endIndex = fullSource.indexOf(scriptEnd) + scriptEnd.length;
        const injectedScript = `${scriptStart}\n    let appData = ${JSON.stringify(publishedData, null, 4)};\n    ${scriptEnd}`;
        const finalHtml = fullSource.substring(0, startIndex) + injectedScript + fullSource.substring(endIndex);
        const blob = new Blob([finalHtml], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'published_standalone_org.html';
        a.click();
    }

    // --- SEARCH ENGINE ---
    function applyFilter() {
        document.querySelectorAll('ul.children-list').forEach(u => u.classList.remove('hidden'));
        document.querySelectorAll('.toggle-btn').forEach(t => t.textContent = '−');

        const search = document.getElementById('searchInput').value.toUpperCase();
        const role = document.getElementById('roleFilter').value;
        const loc = document.getElementById('locFilter').value;
        const tagFilterEl = document.getElementById('tagFilter');
        let selTags = Array.from(tagFilterEl.selectedOptions).map(o => o.value);
        if (selTags.includes("ALL")) selTags = [];

        const items = Array.from(document.querySelectorAll('.tree-item'));
        const nodeMap = {};

        items.forEach(li => {
            const id = li.dataset.id;
            const matchSearch = !search || li.dataset.searchText.includes(search);
            const matchRole = role === "ALL" || li.dataset.role === role;
            const matchLoc = loc === "ALL" || li.dataset.location === loc;
            const nodeTags = li.dataset.tags;
            const matchTags = selTags.length === 0 || selTags.every(t => nodeTags.includes(t));
            nodeMap[id] = { li: li, selfMatch: matchSearch && matchRole && matchLoc && matchTags, visible: false };
        });

        function showPath(id) {
            const entry = nodeMap[id];
            if (!entry || entry.visible) return;
            entry.visible = true;
            const res = findNodeAndParent(id, appData.tree);
            if (res && res.parent) showPath(res.parent.id);
        }

        Object.keys(nodeMap).forEach(id => { if (nodeMap[id].selfMatch) showPath(id); });
        Object.keys(nodeMap).forEach(id => {
            const entry = nodeMap[id];
            entry.li.style.display = entry.visible ? '' : 'none';
            const card = entry.li.querySelector('.node-card');
            if (entry.selfMatch && (search || selTags.length > 0 || role !== "ALL" || loc !== "ALL")) {
                card.classList.add('matched');
            } else { card.classList.remove('matched'); }
        });
    }

    function handleTagSelection(select) {
        const options = Array.from(select.options);
        const allSelected = options.find(o => o.value === "ALL" && o.selected);
        if (allSelected && select.dataset.lastAll !== "true") {
            options.forEach(o => { if (o.value !== "ALL") o.selected = false; });
            select.dataset.lastAll = "true";
        } else if (!allSelected) {
            select.dataset.lastAll = "false";
        } else if (allSelected && options.some(o => o.selected && o.value !== "ALL")) {
            allSelected.selected = false;
            select.dataset.lastAll = "false";
        }
        applyFilter();
    }

    // --- UI ACTIONS ---
    function openGuideModal() { 
        const body = document.getElementById('guideBody');
        if (appData.isReadOnly) {
            body.innerHTML = `
                <p><strong>Viewing & Navigation:</strong></p>
                <ul>
                    <li><strong>Searching:</strong> Type in the sidebar to filter the tree. Parents of matching nodes are always kept visible.</li>
                    <li><strong>Filtering:</strong> Use the dropdowns to isolate specific Roles, Locations, or Skills.</li>
                    <li><strong>Subtrees:</strong> Use the (+) and (-) buttons on the left of cards to expand or collapse specific branches.</li>
                    <li><strong>Toolbar:</strong> Use the icons on the right to Expand All, Collapse All, or toggle Day/Night mode.</li>
                </ul>
            `;
        } else {
            body.innerHTML = `
                <p><strong>Management:</strong></p>
                <ul>
                    <li><strong>Editing:</strong> Click any card to open the editor.</li>
                    <li><strong>Adding:</strong> Hover over a card and click the green (+) button to add a child.</li>
                    <li><strong>Deleting:</strong> Hover over a card and click the red (x) button to remove a node.</li>
                    <li><strong>Moving:</strong> Drag and drop any card onto another to change its parent.</li>
                </ul>
                <p><strong>Customization:</strong></p>
                <ul>
                    <li><strong>Settings:</strong> Click the Gear icon to manage global lists and organization name.</li>
                    <li><strong>Publishing:</strong> Click "Publish to Read-Only" to generate a standalone shareable file.</li>
                </ul>
            `;
        }
        document.getElementById('guideModal').classList.add('active'); 
    }

    function toggleTheme() {
        appData.settings.theme = (appData.settings.theme === "dark") ? "light" : "dark";
        const isDark = appData.settings.theme === "dark";
        document.body.classList.toggle('light-theme', !isDark);
        document.getElementById('sunIcon').style.display = isDark ? "none" : "block";
        document.getElementById('moonIcon').style.display = isDark ? "block" : "none";
    }

    function addChild(parentId, e) {
        if (appData.isReadOnly) return;
        e.stopPropagation();
        const res = findNodeAndParent(parentId, appData.tree);
        const newId = 'n' + Date.now();
        if(!res.node.children) res.node.children = [];
        res.node.children.push({ id: newId, name: "New Person", role: appData.settings.roles[0], location: appData.settings.locations[0], children: [] });
        renderTree();
        openEditModal(newId);
    }

    function deleteNode(id, e) {
        if (appData.isReadOnly) return;
        e.stopPropagation();
        const res = findNodeAndParent(id, appData.tree);
        if (res.parent && confirm("Delete record?")) {
            res.parent.children = res.parent.children.filter(c => c.id !== id);
            renderTree();
        }
    }

    function openSettingsModal() {
        document.getElementById('setOrgName').value = appData.title;
        document.getElementById('setShowTags').checked = appData.settings.showTags;
        document.getElementById('setBWTags').checked = appData.settings.bwTags;
        document.getElementById('setRoles').value = appData.settings.roles.join(', ');
        document.getElementById('setLocs').value = appData.settings.locations.join(', ');
        document.getElementById('setTags').value = appData.settings.tags.join(', ');
        document.getElementById('setEng').value = appData.settings.engagements.join(', ');
        document.getElementById('settingsModal').classList.add('active');
    }

    function saveSettings() {
        appData.title = document.getElementById('setOrgName').value;
        appData.settings.showTags = document.getElementById('setShowTags').checked;
        appData.settings.bwTags = document.getElementById('setBWTags').checked;
        const clean = (id) => [...new Set(document.getElementById(id).value.split(',').map(s => s.trim()).filter(s => s))];
        appData.settings.roles = clean('setRoles');
        appData.settings.locations = clean('setLocs');
        appData.settings.tags = clean('setTags');
        appData.settings.engagements = clean('setEng');
        renderTree();
        document.getElementById('settingsModal').classList.remove('active');
    }

    function openEditModal(id) {
        if (appData.isReadOnly) return;
        const n = findNodeAndParent(id, appData.tree).node;
        document.getElementById('editNodeId').value = id;
        document.getElementById('editName').value = n.name;
        document.getElementById('editEmail').value = n.email || "";
        document.getElementById('editPhone').value = n.phone || "";
        const fill = (id, list, val) => {
            const s = document.getElementById(id);
            s.innerHTML = list.map(i => `<option value="${i}" ${i === val ? 'selected':''}>${i}</option>`).join('');
        };
        fill('editRole', appData.settings.roles, n.role);
        fill('editLocation', appData.settings.locations, n.location);
        fill('editEngagement', appData.settings.engagements, n.engagement);
        const tagS = document.getElementById('editTagsMulti');
        tagS.innerHTML = appData.settings.tags.map(t => `<option value="${t}" ${(n.tags||[]).includes(t) ? 'selected':''}>${t}</option>`).join('');
        document.getElementById('editModal').classList.add('active');
    }

    function saveNodeChanges() {
        const id = document.getElementById('editNodeId').value;
        const n = findNodeAndParent(id, appData.tree).node;
        n.name = document.getElementById('editName').value;
        n.email = document.getElementById('editEmail').value;
        n.phone = document.getElementById('editPhone').value;
        n.role = document.getElementById('editRole').value;
        n.location = document.getElementById('editLocation').value;
        n.engagement = document.getElementById('editEngagement').value;
        n.tags = Array.from(document.getElementById('editTagsMulti').selectedOptions).map(o => o.value);
        renderTree(); closeModal();
    }

    function closeGuideModal() { document.getElementById('guideModal').classList.remove('active'); }
    function closeModal() { document.getElementById('editModal').classList.remove('active'); }
    function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); }
    
    function populateSidebarFilters() {
        const fill = (id, list) => {
            const s = document.getElementById(id); const val = s.value;
            s.innerHTML = '<option value="ALL">Show All</option>' + list.map(i => `<option value="${i.toUpperCase()}">${i}</option>`).join('');
            s.value = val;
        };
        fill('roleFilter', appData.settings.roles);
        fill('locFilter', appData.settings.locations);
        const tf = document.getElementById('tagFilter'); 
        const tval = Array.from(tf.selectedOptions).map(o=>o.value);
        tf.innerHTML = '<option value="ALL">Show All</option>' + appData.settings.tags.map(t => `<option value="${t.toUpperCase()}" ${tval.includes(t.toUpperCase())?'selected':''}>${t}</option>`).join('');
    }

    function triggerUpload() { document.getElementById('jsonFileInput').click(); }
    function saveJson() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(appData, null, 2)], {type:'application/json'})); a.download='org.json'; a.click(); }
    function importJson(i) { const r = new FileReader(); r.onload = (e) => { appData = JSON.parse(e.target.result); renderTree(); }; r.readAsText(i.files[0]); }
    function expandAll() { document.querySelectorAll('ul.children-list').forEach(u => u.classList.remove('hidden')); document.querySelectorAll('.toggle-btn').forEach(t => t.textContent = '−'); }
    function collapseAll() { document.querySelectorAll('ul.children-list').forEach(u => u.classList.add('hidden')); document.querySelectorAll('.toggle-btn').forEach(t => t.textContent = '+'); }

    // Init Theme
    if (appData.settings.theme === "light") { document.body.classList.add('light-theme'); document.getElementById('sunIcon').style.display = "block"; document.getElementById('moonIcon').style.display = "none"; }
    renderTree();
</script>
</body>
</html>
